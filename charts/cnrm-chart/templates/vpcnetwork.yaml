{{- if .Values.vpcNetwork }}
{{- $allowResourceDeletion := .Values.allowResourceDeletion }}
{{- $projectName := include "cnrm-chart.projectID" . }}
{{- range .Values.vpcNetwork }}
---
apiVersion: compute.cnrm.cloud.google.com/v1beta1
kind: ComputeNetwork
metadata:
  annotations:
    {{- include "cnrm-chart.cnrmAnnotations" (dict "projectName" $projectName "allowResourceDeletion" $allowResourceDeletion) | nindent 4 }}
    {{- include "cnrm-chart.customAnnotations" (dict "annotations" .customAnnotations) | nindent 4 }}
  name: {{ include "cnrm-chart.resourceName" (dict "projectName" $projectName "name" .networkName) }}
spec:
  resourceID: {{ .networkName }}
  {{- if .autoCreateSubnetworks }}
  autoCreateSubnetworks: true
  {{- else }}
  autoCreateSubnetworks: false
  {{- end }}
  {{- if .description }}
  description: {{ .description | quote }}
  {{- end }}
  mtu: {{ .mtu | default 1460 }}
  routingMode: {{ .routingMode | default "REGIONAL" }}
  networkFirewallPolicyEnforcementOrder: {{ .networkFirewallPolicyEnforcementOrder | default "AFTER_CLASSIC_FIREWALL" }}
{{- if .subNets }}
{{- $networkName := .networkName }}
{{- range .subNets }}
---
apiVersion: compute.cnrm.cloud.google.com/v1beta1
kind: ComputeSubnetwork
metadata:
  annotations:
    {{- include "cnrm-chart.cnrmAnnotations" (dict "projectName" $projectName "allowResourceDeletion" $allowResourceDeletion) | nindent 4 }}
  name: {{ include "cnrm-chart.resourceName" (dict "projectName" $projectName "name" .subnetName) }}
spec:
  resourceID: {{ .subnetName }}
  ipCidrRange: {{ .subnetCidr }}
  region: {{ .vpcRegion }}
  networkRef:
    name: {{ include "cnrm-chart.resourceName" (dict "projectName" $projectName "name" $networkName) }}
  {{- if .purpose }}
  purpose: {{ .purpose }}
  {{- end }}
  {{- if not .role }}
  {{- if or (eq .purpose "INTERNAL_HTTPS_LOAD_BALANCER") (eq .purpose "REGIONAL_MANAGED_PROXY")}}
  role: ACTIVE
  {{- end }}
  {{- else }}
  role: {{ .role }}
  {{- end }}
  {{- if .privateIpGoogleAccess }}
  privateIpGoogleAccess: {{ .privateIpGoogleAccess }}
  {{- end }}
  {{- with .logConfig }}
  logConfig:
    {{- if .aggregationInterval }}
    aggregationInterval: {{ .aggregationInterval }}
    {{- end }}
    {{- if .flowSampling }}
    flowSampling: {{ .flowSampling }}
    {{- end }}
    {{- if .metadata }}
    metadata: {{ .metadata }}
    {{- end }}
  {{- end }}
  {{- if .secondarySubnets }}
  secondaryIpRange:
    {{- range .secondarySubnets }}
    - rangeName: {{ .name }}
      ipCidrRange: {{ .ipCidrRange }}
    {{- end }}
  {{- end }}
  {{- if and (ne .purpose "INTERNAL_HTTPS_LOAD_BALANCER") (ne .purpose "REGIONAL_MANAGED_PROXY")}}
  stackType: {{ .stackType | default "IPV4_ONLY"}}
  {{- end }}
{{- end -}}
{{- end -}}
{{- end -}}
{{- end -}}