name: Release charts
on:
  push:
    branches:
      - master
    paths:
      - 'charts/**'
  workflow_dispatch:
jobs:
  bump-versions:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    - name: Bump cnrm-chart
      uses: ./.github/actions/bumpVersionAction
      with:
        chart: cnrm-chart

    - name: Bump gateway-api-chart
      uses: ./.github/actions/bumpVersionAction
      with:
        chart: gateway-api-chart

    - name: Bump snipeit
      uses: ./.github/actions/bumpVersionAction
      with:
        chart: snipeit

    - name: Push Results
      id: pushResults
      run: |
        if git merge-base --is-ancestor HEAD @{u} ; then
          echo "publish=false" >> $GITHUB_OUTPUT
          echo "No push necessary"
        else
          echo "Version bumps happened. Pushing now..."
          git push
          echo "publish=true" >> $GITHUB_OUTPUT
        fi
    outputs:
      publish: ${{ steps.pushResults.outputs.publish }}

  chart-releaser:
    runs-on: ubuntu-latest
    needs:
      - bump-versions
    if: needs.bump-versions.outputs.publish == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git pull --ff-only

      - name: Install Helm
        uses: azure/setup-helm@v4.3.1
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Add Helm repo(s)
        run: |
          helm repo add t3n-helm-charts https://storage.googleapis.com/t3n-helm-charts

      - name: Extract version-specific release notes
        run: |
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
            echo "Processing $chart_name version $version"
            # Extract section between [v$version] and next ## heading
            sed -n "/## \[v${version}\]/,/^## \[/p" "$chart/CHANGELOG.md" | sed '$d' > "$chart/RELEASE_NOTES.md" || echo "No release notes found for $chart_name v$version"
          done

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_RELEASE_NOTES_FILE: "RELEASE_NOTES.md"
          CR_SKIP_EXISTING: true